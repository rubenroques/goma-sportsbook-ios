name: Auto-Distribute Betsson Cameroon

# Triggers:
# 1. Manual workflow_dispatch (can select environment)
# 2. Push to devices.txt (triggers staging build)
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - staging
          - production
      release_notes:
        description: 'Release notes (optional)'
        required: false
        type: string

  push:
    paths:
      - 'BetssonCameroonApp/fastlane/devices.csv'
    branches:
      - main
      - betsson-cm  # Adjust to your main branch

jobs:
  auto-distribute:
    name: Register Devices & Distribute
    runs-on: macos-14  # macOS runner with Xcode
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true  # Automatically runs bundle install and caches gems
          working-directory: BetssonCameroonApp

      - name: Setup App Store Connect API Key
        working-directory: BetssonCameroonApp/fastlane
        env:
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          echo "ğŸ“ Setting up App Store Connect API Key..."
          # Write the .p8 file from secret
          echo "$APP_STORE_CONNECT_API_KEY_CONTENT" > AuthKey_7NC93JSN42.p8
          chmod 600 AuthKey_7NC93JSN42.p8
          echo "âœ… API Key file created: AuthKey_7NC93JSN42.p8"
          ls -lh AuthKey_7NC93JSN42.p8

      - name: Setup environment variables
        working-directory: BetssonCameroonApp/fastlane
        env:
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          FIREBASE_CLI_TOKEN: ${{ secrets.FIREBASE_CLI_TOKEN }}
          FIREBASE_PROJECT_NUMBER: ${{ secrets.FIREBASE_PROJECT_NUMBER }}
          GOMA_TEAM_ID: ${{ secrets.GOMA_TEAM_ID }}
          BETSSONCM_STG_FIREBASE_APP_ID: ${{ secrets.BETSSONCM_STG_FIREBASE_APP_ID }}
          BETSSONCM_PROD_FIREBASE_APP_ID: ${{ secrets.BETSSONCM_PROD_FIREBASE_APP_ID }}
        run: |
          echo "ğŸ“ Creating .env file from GitHub secrets..."
          # Create .env file from secrets
          # Note: FIREBASE_DISTRIBUTION_GROUPS and TESTERS are defined in Fastfile as constants
          cat > .env << EOF
          MATCH_GIT_URL=$MATCH_GIT_URL
          MATCH_PASSWORD=$MATCH_PASSWORD
          APP_STORE_CONNECT_API_KEY_ID=$APP_STORE_CONNECT_API_KEY_ID
          APP_STORE_CONNECT_API_ISSUER_ID=$APP_STORE_CONNECT_API_ISSUER_ID
          APP_STORE_CONNECT_API_KEY_FILEPATH=./fastlane/AuthKey_7NC93JSN42.p8
          FIREBASE_CLI_TOKEN=$FIREBASE_CLI_TOKEN
          FIREBASE_PROJECT_NUMBER=$FIREBASE_PROJECT_NUMBER
          GOMA_TEAM_ID=$GOMA_TEAM_ID
          BETSSONCM_STG_FIREBASE_APP_ID=$BETSSONCM_STG_FIREBASE_APP_ID
          BETSSONCM_PROD_FIREBASE_APP_ID=$BETSSONCM_PROD_FIREBASE_APP_ID
          EOF
          echo "âœ… .env file created"
          echo "ğŸ“‹ Environment variables (secrets masked):"
          echo "   - MATCH_GIT_URL: ${MATCH_GIT_URL:0:30}..."
          echo "   - GOMA_TEAM_ID: $GOMA_TEAM_ID"
          echo "   - APP_STORE_CONNECT_API_KEY_ID: $APP_STORE_CONNECT_API_KEY_ID"
          echo "   - FIREBASE_PROJECT_NUMBER: $FIREBASE_PROJECT_NUMBER"

      - name: Setup SSH for Match
        env:
          MATCH_GIT_PRIVATE_KEY: ${{ secrets.MATCH_GIT_PRIVATE_KEY }}
        run: |
          echo "ğŸ”‘ Setting up SSH for Match certificates repo..."

          # TEMPORARY DEBUG - REMOVE AFTER FIXING
          echo "ğŸ› DEBUG: Checking SSH key secret..."
          if [ -z "$MATCH_GIT_PRIVATE_KEY" ]; then
            echo "âŒ ERROR: MATCH_GIT_PRIVATE_KEY is empty!"
            exit 1
          fi

          echo "âœ… Secret is not empty"
          echo "ğŸ“ Secret length: ${#MATCH_GIT_PRIVATE_KEY} characters"

          # Show first and last lines (headers/footers) - safe to show
          echo "ğŸ” First line of key:"
          echo "$MATCH_GIT_PRIVATE_KEY" | head -n 1
          echo "ğŸ” Last line of key:"
          echo "$MATCH_GIT_PRIVATE_KEY" | tail -n 1
          echo "ğŸ” Total lines in key:"
          echo "$MATCH_GIT_PRIVATE_KEY" | wc -l

          # Create SSH directory
          mkdir -p ~/.ssh

          # Write key to file
          echo "$MATCH_GIT_PRIVATE_KEY" > ~/.ssh/match_deploy_key
          chmod 600 ~/.ssh/match_deploy_key

          # Verify file was created
          echo "ğŸ“ SSH key file info:"
          ls -lh ~/.ssh/match_deploy_key
          echo "ğŸ“„ File size: $(wc -c < ~/.ssh/match_deploy_key) bytes"
          echo "ğŸ“„ File lines: $(wc -l < ~/.ssh/match_deploy_key)"

          # Try to validate the key format
          echo "ğŸ” Validating SSH key format..."
          if ssh-keygen -l -f ~/.ssh/match_deploy_key 2>&1; then
            echo "âœ… SSH key format is valid!"
          else
            echo "âŒ SSH key format validation failed!"
            echo "ğŸ› DEBUG: Showing first 5 lines of key file (TEMPORARY - WILL REMOVE):"
            head -n 5 ~/.ssh/match_deploy_key
            echo "ğŸ› DEBUG: Showing last 5 lines of key file:"
            tail -n 5 ~/.ssh/match_deploy_key
            exit 1
          fi

          echo "âœ… SSH key installed"

          echo "ğŸ“¡ Adding github.com to known hosts..."
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          echo "âš™ï¸  Configuring SSH to use deploy key..."
          # Configure git to use the SSH key
          cat > ~/.ssh/config << EOF
          Host github.com
            HostName github.com
            IdentityFile ~/.ssh/match_deploy_key
            IdentitiesOnly yes
          EOF

          echo "ğŸ“‹ SSH config contents:"
          cat ~/.ssh/config

          # Test SSH connection
          echo "ğŸ§ª Testing SSH connection to github.com..."
          ssh -T -i ~/.ssh/match_deploy_key git@github.com 2>&1 || echo "âš ï¸  SSH test completed (exit code expected for test)"

          echo "âœ… SSH configuration complete"

      - name: Determine environment
        id: determine-env
        run: |
          echo "ğŸ¯ Determining deployment environment..."
          echo "ğŸ“Œ Trigger: ${{ github.event_name }}"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
            NOTES="${{ github.event.inputs.release_notes }}"
            echo "âœ… Manual trigger - Environment: $ENV"
            echo "environment=$ENV" >> $GITHUB_OUTPUT
            echo "release_notes=$NOTES" >> $GITHUB_OUTPUT
          else
            # Push to devices.csv triggers staging
            echo "âœ… Automatic trigger (devices.csv changed) - Environment: staging"
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "release_notes=Automated build with updated device list" >> $GITHUB_OUTPUT
          fi

          echo "ğŸ“ Release notes: $(cat $GITHUB_OUTPUT | grep release_notes | cut -d'=' -f2-)"

      - name: Keep version and distribute (Staging)
        if: steps.determine-env.outputs.environment == 'staging'
        working-directory: BetssonCameroonApp
        run: |
          echo "ğŸš€ Starting distribution to STAGING environment..."
          echo "ğŸ“¦ Build will keep current version number"
          echo "ğŸ“± Devices will be registered from devices.csv"

          if [ -n "${{ steps.determine-env.outputs.release_notes }}" ]; then
            echo "ğŸ“ Using custom release notes"
            bundle exec fastlane keep_version_distribute_staging release_notes:"${{ steps.determine-env.outputs.release_notes }}"
          else
            echo "ğŸ“ Using default release notes"
            bundle exec fastlane keep_version_distribute_staging
          fi

          echo "âœ… Distribution to staging complete!"

      - name: Keep version and distribute (Production)
        if: steps.determine-env.outputs.environment == 'production'
        working-directory: BetssonCameroonApp
        run: |
          echo "ğŸš€ Starting distribution to PRODUCTION environment..."
          echo "ğŸ“¦ Build will keep current version number"
          echo "ğŸ“± Devices will be registered from devices.csv"

          if [ -n "${{ steps.determine-env.outputs.release_notes }}" ]; then
            echo "ğŸ“ Using custom release notes"
            bundle exec fastlane keep_version_distribute_production release_notes:"${{ steps.determine-env.outputs.release_notes }}"
          else
            echo "ğŸ“ Using default release notes"
            bundle exec fastlane keep_version_distribute_production
          fi

          echo "âœ… Distribution to production complete!"

      - name: Upload build artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fastlane-logs
          path: |
            BetssonCameroonApp/fastlane/logs/
            BetssonCameroonApp/fastlane/report.xml
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up sensitive files..."
          rm -f ~/.ssh/match_deploy_key && echo "   âœ… Removed SSH key"
          rm -f BetssonCameroonApp/fastlane/.env && echo "   âœ… Removed .env file"
          rm -f BetssonCameroonApp/fastlane/AuthKey_7NC93JSN42.p8 && echo "   âœ… Removed API key"
          echo "âœ… Cleanup complete"
