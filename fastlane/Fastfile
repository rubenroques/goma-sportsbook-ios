require 'dotenv'

# Load environment variables
Dotenv.load('.env')

ENV["FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT"] = "120"

# Verify Apple credentials are set
unless ENV["FASTLANE_USER"] && ENV["FASTLANE_PASSWORD"]
  UI.important "‚ö†Ô∏è  Fastlane credentials not found in environment variables"
  UI.important "Please set FASTLANE_USER and FASTLANE_PASSWORD in your .env file"
end

# Fastfile
default_platform(:ios)

# Simple mapping between Xcode schemes and internal IDs
SCHEME_MAPPING = {
  "Betsson UAT" => "BETSSON_UAT",
  "Betsson PROD" => "BETSSON_PROD"
}

# before_all do |lane|
#   ensure_git_status_clean unless lane == :test
#   ensure_bundle_exec
# end

after_all do |lane|
  notification(subtitle: "Fastlane", message: "#{lane} completed successfully! üéâ")
end

error do |lane, exception|
  notification(subtitle: "Fastlane", message: "#{lane} failed with error: #{exception}")
end

platform :ios do

  desc "Print environment variables and arguments"
  lane :test do |options|
    UI.message "üîç Printing Environment Variables:"
    UI.message "--------------------------------"
    ENV.sort.each do |key, value|
      UI.message "#{key} = #{value}"
    end

    UI.message "\nüìù Printing Lane Options/Arguments:"
    UI.message "--------------------------------"
    if options && !options.empty?
      options.each do |key, value|
        UI.message "#{key} = #{value}"
      end
    else
      UI.message "No arguments passed to the lane"
    end
  end

  desc "Update build number"
  lane :version_bump do
    # Get current build number
    current_build = get_build_number(xcodeproj: "Sportsbook.xcodeproj")
    puts "Current build number (CURRENT_PROJECT_VERSION): #{current_build}"
    
    # Prompt for new build number
    new_build = prompt(text: "Enter new build number (CURRENT_PROJECT_VERSION):")
    
    # Update build number
    increment_build_number(
      build_number: new_build,
      xcodeproj: "Sportsbook.xcodeproj",
      skip_info_plist: true
    )
    
    puts "Build number updated to: #{new_build}"
  end

  desc "Update marketing version"
  lane :marketing_version_bump do
    # Get current version
    current_version = get_version_number(xcodeproj: "Sportsbook.xcodeproj")
    puts "Current version (MARKETING_VERSION): #{current_version}"
    
    # Prompt for new version
    new_version = prompt(text: "Enter new version number (MARKETING_VERSION):")
    
    # Update version
    increment_version_number(
      version_number: new_version,
      xcodeproj: "Sportsbook.xcodeproj"
    )
    
    puts "Version updated to: #{new_version}"
  end

  desc "Setup certificates and provisioning profiles"
  lane :certificates do |options|
    app_scheme = options[:app_scheme]
    
    # Get internal ID from scheme mapping if a scheme is provided
    internal_id = app_scheme ? SCHEME_MAPPING[app_scheme] : app_scheme
    
    # Validate scheme if provided
    if internal_id && !ENV["#{internal_id}_APP_ID"]
      UI.user_error!("Invalid scheme: #{app_scheme}")
    end

    # Set Match parameters based on environment
    match_params = {
      type: "adhoc",
      force_for_new_devices: true,
      readonly: true,
      force: options[:force] || false
    }

    case internal_id
    when "BETSSON_UAT"
      match_params.merge!({
        git_url: ENV["MATCH_GIT_URL_UAT"],
        username: ENV["BETSSON_UAT_APPLE_ID"],
        team_id: ENV["BETSSON_UAT_TEAM_ID"],
        app_identifier: ENV["BETSSON_UAT_APP_ID"]
      })
    when "BETSSON_PROD"
      match_params.merge!({
        git_url: ENV["MATCH_GIT_URL_PROD"],
        username: ENV["BETSSON_PROD_APPLE_ID"],
        team_id: ENV["BETSSON_PROD_TEAM_ID"],
        app_identifier: ENV["BETSSON_PROD_APP_ID"]
      })
    else
      UI.user_error!("Please specify a valid scheme: 'Betsson UAT' or 'Betsson PROD'")
    end
    
    # Register new devices
    register_devices(
      devices_file: "./fastlane/devices.txt",
      username: match_params[:username],
      team_id: match_params[:team_id]
    )
    
    # Fetch certificates and profiles
    match(match_params)
  end

  desc "Build and distribute to Firebase"
  lane :distribute_to_firebase do |options|
    UI.message "üöÄ Starting distribution process..."
    
    app_scheme = options[:app_scheme]
    environment = options[:environment]
    release_notes = options[:release_notes]
    
    UI.message "üì± Building for scheme: #{app_scheme}"
    UI.message "üåç Environment: #{environment}"
    
    # Get internal ID from scheme mapping
    internal_id = SCHEME_MAPPING[app_scheme]
    unless internal_id
      UI.user_error!("Invalid scheme: #{app_scheme}. Must be one of: #{SCHEME_MAPPING.keys.join(', ')}")
    end
    
    UI.message "üîç Using internal ID: #{internal_id}"
    
    # Validate scheme and environment variables
    unless ENV["#{internal_id}_FIREBASE_APP_ID"]
      UI.user_error!("Missing Firebase App ID for scheme: #{app_scheme}")
    end
    
    firebase_cli_token = ENV["FIREBASE_#{environment}_CLI_TOKEN"]
    firebase_groups = ENV["FIREBASE_#{environment}_DISTRIBUTION_GROUPS"] || "ios-internal"
    
    unless firebase_cli_token
      UI.user_error!("Missing Firebase CLI token for environment: #{environment}")
    end

    # Generate release notes if not provided
    #unless release_notes
    #  UI.message "üìù Generating release notes from git commits..."
    #  # Get last 5 commits
    #  changelog = changelog_from_git_commits(
    #    commits_count: 5,
    #    pretty: "- %s",
    #    date_format: "short",
    #    match_lightweight_tag: false,
    #    merge_commit_filtering: "exclude_merges"
    #  )
    #  version = get_version_number(xcodeproj: "Sportsbook.xcodeproj")
    #  build = get_build_number(xcodeproj: "Sportsbook.xcodeproj")
    #  
    #  UI.message "üìä Version: #{version}, Build: #{build}"
    #  release_notes = "#{app_scheme} v#{version} (#{build})\n\nRecent changes:\n#{changelog}"
    #end
    
    # Run tests if requested
    #if options[:run_tests]
    #  UI.message "üß™ Running tests..."
    #  test
    #end
    
    # Update certificates
    UI.message "üîê Updating certificates..."
    certificates(app_scheme: app_scheme)
    
    # Print Xcode version
    UI.message "üõ† Xcode Version:"
    sh("xcodebuild -version")
    
    # Print available schemes
    UI.message "üìã Available Schemes:"
    sh("xcodebuild -list -project ../Sportsbook.xcodeproj")
    
    # Print build settings
    UI.message "‚öôÔ∏è Build Settings for #{app_scheme}:"
    sh("xcodebuild -showBuildSettings -scheme \"#{app_scheme}\" -project ../Sportsbook.xcodeproj")
    
    UI.message "üèó Starting build process..."
    
    # Build app with detailed output
    build_ios_app(
      scheme: app_scheme,
      clean: true,
      silent: false,
      suppress_xcode_output: false,
      skip_profile_detection: true,
      export_method: "ad-hoc",
      export_options: {
        compileBitcode: false,
        uploadBitcode: false,
        uploadSymbols: true,
        manageAppVersionAndBuildNumber: false
      },
      buildlog_path: "fastlane/logs",
      output_directory: "fastlane/builds",
      xcargs: "-verbose",
      analyze_build_time: true,
      include_symbols: true,
      include_bitcode: false,
      export_xcargs: "-verbose"
    )
    
    UI.message "üì¶ Build completed. Uploading to Firebase..."
    
    # Upload to Firebase
    firebase_app_distribution(
      app: ENV["#{internal_id}_FIREBASE_APP_ID"],
      firebase_cli_token: firebase_cli_token,
      groups: firebase_groups,
      release_notes: release_notes,
      debug: true
    )
    
    UI.success "‚úÖ Distribution completed successfully!"
    
    # Print build time summary
    UI.message "‚è± Build time summary available in fastlane/logs"
  end

  # Existing lanes with improved error handling
  lane :betsson_uat do |options|
    distribute_to_firebase(
      app_scheme: "Betsson UAT",
      environment: "UAT",
      run_tests: true,
      release_notes: options[:release_notes]
    )
  end

  lane :betsson_prod do |options|
    distribute_to_firebase(
      app_scheme: "Betsson PROD",
      environment: "PROD",
      run_tests: true,
      release_notes: options[:release_notes]
    )
  end

  lane :betsson do |options|
    version_bump
    betsson_uat(release_notes: options[:release_notes])
    #betsson_prod(release_notes: options[:release_notes])
  end

  desc "Hardcoded lane for Betsson PROD with extension support"
  lane :betsson_prod_hardcoded do
    # Get certificates for both main app and extension
    match(
      type: "adhoc",
      git_url: "git@github.com:gomagaming/BetssonFastlaneAppleCertificates.git",
      app_identifier: [
        "fr.betsson.ios.app",
        "fr.betsson.ios.app.betssonNotificationsService"
      ],
      username: "ruben@gomadevelopment.pt",
      team_id: "QN2DYX5K4M",
      readonly: false
    )
    
    # Build the app
    build_ios_app(
      scheme: "Betsson PROD",
      clean: true,
      export_method: "ad-hoc",
      skip_profile_detection: true
    )
  end
end
